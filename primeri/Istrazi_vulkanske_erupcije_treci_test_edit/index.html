<html lang="hr"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Istraži vulkanske erupcije</title>
<style>
  /* audience: srednja škola, geografija */
  :root{
    --bg:#e8f0f6;
    --mount:#5b3b2e;
    --rock:#3f2d24;
    --lava:#ff4b2b;
    --lava-deep:#ff7a1a;
    --forest:#228B22;
    --smoke:#6b6b6b;
    --panel-bg: rgba(255,255,255,0.95);
  }
  html,body{height:100%;margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(#cfe8ff,var(--bg));color:#1b2430;}
  .container{max-width:1100px;margin:18px auto;padding:18px;}
  h1{margin:0 0 8px;font-size:28px;text-align:center;}
  p.description{margin:0 0 14px;text-align:center;color:#123;}
  .scene-wrap{display:flex;gap:12px;align-items:flex-start;justify-content:center;}
  .svg-area{background:linear-gradient(#dff3ff, transparent);border-radius:12px;padding:12px;box-shadow:0 4px 10px rgba(0,0,0,0.12);}
  svg{display:block;max-width:760px;width:760px;height:420px;}
  .controls{display:flex;flex-direction:column;gap:8px;margin-left:10px;}
  button{padding:8px 12px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:#fff;cursor:pointer;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
  button:hover{transform:translateY(-2px)}
  .panel{width:300px;background:var(--panel-bg);padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.08);font-size:14px;}
  .panel h3{margin:0 0 8px;font-size:16px;}
  .panel p{margin:4px 0;color:#222;min-height:46px;}
  .panel.small{width:220px;}
  .clickable{cursor:pointer}
  /* Volcano visuals */
  .volcano-base{fill:var(--mount);stroke:var(--rock);stroke-width:2;}
  .crater{fill:#2b1f1b;stroke:#1a0f0f;stroke-width:1.5;}
  .lava-pool{fill: linear-gradient(var(--lava), var(--lava-deep));}
  /* Lava flow (initially hidden) */
  .lava-flow{fill: url(#lavaGrad); transform-origin: 380px 180px; transform-box: fill-box; opacity:0; transition:opacity 0.6s ease, transform 1.2s ease;}
  .lava-flow.active{opacity:1; transform:scaleY(1);}
  .lava-flow.hidden{transform: scaleY(0);}
  /* animated lava droplets */
  .lava-drop{fill:var(--lava-deep); opacity:0; filter:drop-shadow(0 4px 6px rgba(255,80,40,0.4)); }
  .lava-drop.animate{animation:dropDown 1.6s linear infinite;}
  @keyframes dropDown{
    0%{transform: translate(0,-20px) scale(0.9); opacity:0;}
    10%{opacity:1;}
    70%{transform: translate(30px,120px) scale(1);}
    100%{opacity:0; transform: translate(40px,160px) scale(0.9);}
  }
  /* Forest visuals */
  .tree-trunk{fill:#5a331e;}
  .tree-leaf{fill:var(--forest);stroke:#0f620f;stroke-width:1;}
  .forest-area{cursor:pointer}
  /* smoke */
  .smoke{fill:var(--smoke);opacity:0;}
  .smoke.rising{animation:smokeRise 3.2s ease-in-out infinite;opacity:0.9;}
  .smoke.rising.slow{animation-duration:4.2s;}
  @keyframes smokeRise{
    0%{transform: translateY(0) scale(0.9); opacity:0;}
    20%{opacity:0.6;}
    60%{transform: translateY(-90px) scale(1.1); opacity:0.35;}
    100%{transform: translateY(-140px) scale(1.3); opacity:0;}
  }
  /* lightning visuals */
  .lightning-bolt{fill:none;stroke:#fffdd0;stroke-width:4;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 0 8px rgba(255,255,200,0.9));opacity:0;transform-origin:450px 80px;transition:opacity 120ms ease;}
  .lightning-bolt.flash{opacity:1;stroke-width:6;}
  #skyFlash{fill:#fff;opacity:0;pointer-events:none;transition:opacity 80ms linear;}
  @keyframes lightningFlicker {
    0%{opacity:0.0;}
    10%{opacity:0.9;}
    25%{opacity:0.0;}
    40%{opacity:0.7;}
    60%{opacity:0.0;}
    100%{opacity:0.0;}
  }
  /* small labels */
  .label{font-size:12px;fill:#222;font-weight:600;}
  footer{margin-top:14px;text-align:center;color:#123;font-size:13px;}
  /* responsive */
  @media (max-width:900px){
    .scene-wrap{flex-direction:column;align-items:center;}
    .controls{flex-direction:row;margin-left:0;}
    .panel{width:95%;}
  }
</style>
</head>
<body>
<div class="container">
  <h1>Istraži vulkanske erupcije</h1>
  <p class="description">Interaktivni alat koji učenicima pokazuje kako vulkani funkcionišu i kakve efekte imaju na okolinu prilikom erupcija.</p>

  <div class="scene-wrap">
    <div class="svg-area" aria-hidden="false">
      <svg id="scene" viewBox="0 0 900 540" role="img" aria-label="Scena vulkana i šume">
        <defs>
          <linearGradient id="lavaGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#ff8b4a"></stop>
            <stop offset="50%" stop-color="#ff4b2b"></stop>
            <stop offset="100%" stop-color="#ffb04f"></stop>
          </linearGradient>
          <linearGradient id="skyGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#cdeeff"></stop>
            <stop offset="100%" stop-color="#a9d8ff"></stop>
          </linearGradient>
          <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="6" result="blur"></feGaussianBlur>
            <feMerge><feMergeNode in="blur"></feMergeNode><feMergeNode in="SourceGraphic"></feMergeNode></feMerge>
          </filter>
        </defs>

        <!-- background sky -->
        <rect x="0" y="0" width="900" height="540" fill="url(#skyGrad)"></rect>

        <!-- sky flash overlay for lightning -->
        <rect id="skyFlash" x="0" y="0" width="900" height="540" style=""></rect>

        <!-- distant hills -->
        <g id="hills" opacity="0.9" transform="translate(-5.391118432172387,0)">
          <path d="M0 360 Q120 320 240 360 T480 360 T720 360 T900 360 L900 540 L0 540 Z" fill="#9ecb8e"></path>
          <path d="M0 380 Q150 330 330 380 T660 380 T900 380 L900 540 L0 540 Z" fill="#8cc07a" opacity="0.9"></path>
        </g>

        <!-- lightning group (initially empty) -->
        <g id="lightningGroup" aria-hidden="true"></g>

        <!-- volcano centered -->
        <g id="volcano" class="clickable" transform="translate(190,20)" aria-label="Vulkan (kliknite za simulaciju)" tabindex="0">
          <!-- base mountain -->
          <path class="volcano-base" d="M200 380 L80 220 C80 220 120 210 140 170 C160 130 180 120 200 120 C220 120 240 130 260 170 C280 210 320 220 320 220 L200 380 Z" style="transition: transform 0.4s; transform-origin: 200px 220px;"></path>
          <!-- crater rim -->
          <ellipse class="crater" cx="200" cy="124" rx="36" ry="12" style="transition: transform 0.22s; transform-origin: 200px 124px;"></ellipse>
          <!-- small lava pool in crater (initial subtle) -->
          <ellipse cx="200" cy="128" rx="22" ry="6" fill="#ff8b4a" opacity="0.9"></ellipse>
          <!-- lava flow path (hidden initially) -->
          <path id="lavaFlowPath" class="lava-flow hidden" d="M230 134 C240 160 260 200 270 230 C280 260 290 300 300 340 L312 380 L250 380 C240 350 220 320 200 300 C180 280 160 270 140 260 L148 230 C160 210 180 190 200 180 C210 175 220 150 230 134 Z" fill="url(#lavaGrad)" style="transition: filter 0.25s, transform 0.25s; transform: scaleY(1);"></path>
          <!-- labels -->
          <text x="180" y="405" class="label">Vulkan</text>
        </g>

        <!-- lava droplets: will be animated individually by JS by toggling classes -->
        <g id="lavaDrops" transform="translate(190,20)">
          <ellipse class="lava-drop" id="drop1" cx="220" cy="150" rx="8" ry="5" style=""></ellipse>
          <ellipse class="lava-drop" id="drop2" cx="226" cy="154" rx="7" ry="4" style=""></ellipse>
          <ellipse class="lava-drop" id="drop3" cx="232" cy="158" rx="6" ry="4" style=""></ellipse>
        </g>

        <!-- forests left and right -->
        <g id="forestLeft" class="forest-area clickable" transform="translate(10,160)" aria-label="Šuma (kliknite za simulaciju)" tabindex="0">
          <!-- multiple trees -->
          <g class="tree" transform="translate(50,180)">
            <rect class="tree-trunk" x="8" y="20" width="10" height="30" rx="2"></rect>
            <circle class="tree-leaf" cx="14" cy="14" r="22" style="transition: fill 1.2s; fill: rgb(123, 92, 43); opacity: 1;"></circle>
          </g>
          <g class="tree" transform="translate(10,200)">
            <rect class="tree-trunk" x="8" y="20" width="10" height="30" rx="2"></rect>
            <circle class="tree-leaf" cx="14" cy="14" r="18" style="transition: fill 1.2s; fill: rgb(123, 92, 43); opacity: 1;"></circle>
          </g>
          <g class="tree" transform="translate(90,200)">
            <rect class="tree-trunk" x="8" y="20" width="10" height="30" rx="2"></rect>
            <circle class="tree-leaf" cx="14" cy="14" r="20" style="transition: fill 1.2s; fill: rgb(123, 92, 43); opacity: 1;"></circle>
          </g>
          <text x="20" y="245" class="label">Šuma</text>
          <!-- smoke group (hidden initially) -->
          <g id="forestSmoke" transform="translate(70,90)"></g>
        </g>

        <g id="forestRight" class="forest-area clickable" transform="translate(530,180)" aria-label="Šuma desno (kliknite za simulaciju)" tabindex="0">
          <g class="tree" transform="translate(30,160)">
            <rect class="tree-trunk" x="8" y="20" width="10" height="30" rx="2"></rect>
            <circle class="tree-leaf" cx="14" cy="14" r="22" style="transition: fill 1.2s; fill: rgb(123, 92, 43); opacity: 1;"></circle>
          </g>
          <g class="tree" transform="translate(80,180)">
            <rect class="tree-trunk" x="8" y="20" width="10" height="30" rx="2"></rect>
            <circle class="tree-leaf" cx="14" cy="14" r="18" style="transition: fill 1.2s; fill: rgb(123, 92, 43); opacity: 1;"></circle>
          </g>
          <text x="20" y="245" class="label">Šuma</text>
        </g>

        <!-- ground road -->
        <g id="road">
          <rect x="0" y="380" width="900" height="160" fill="#e8e3d9" opacity="0.95"></rect>
          <rect x="300" y="396" width="300" height="22" fill="#c0bcbc" opacity="0.7"></rect>
          <rect x="450" y="396" width="30" height="4" fill="#fff" opacity="0.6"></rect>
        </g>

      </svg>
    </div>

    <div class="controls" aria-hidden="false">
      <div class="panel" id="volcanoPanel">
        <h3>Vulkan</h3>
        <p id="volcanoText">Kliknite na vulkan da biste započeli simulaciju erupcije.</p>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="simulateVolcano">Pokreni erupciju (vulkan)</button>
          <button id="resetBtn" title="Resetuj scenu">Resetuj</button>
        </div>
      </div>

      <div class="panel small" id="forestPanel" style="margin-top:10px;">
        <h3>Šuma</h3>
        <p id="forestText">Šuma je pogođena erupcijom, drveće se suši i sagoreva.</p>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="simulateForest">Prikaži efekat na šumu</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Interakcije: kliknite na Vulkan ili Šumu. Koristite Reset za vraćanje početnog stanja.</footer>
</div>

<script>
/*
  Audience: srednja škola, geografija
  Tool: Interactive volcano eruption simulation based on IF-THEN logic.
*/

(function(){
  // State tracking
  const state = {
    volcanoClicks: 0,
    forestClicks: 0,
    lavaActive: false,
    smokeActive: false,
    lightningTimer: null
  };

  // Elements
  const volcanoGroup = document.getElementById('volcano');
  const forestLeft = document.getElementById('forestLeft');
  const forestRight = document.getElementById('forestRight');
  const volcanoText = document.getElementById('volcanoText');
  const forestText = document.getElementById('forestText');
  const lavaPath = document.getElementById('lavaFlowPath');
  const lavaDropsGroup = document.getElementById('lavaDrops');
  const forestSmokeGroup = document.getElementById('forestSmoke');
  const simulateVolcanoBtn = document.getElementById('simulateVolcano');
  const simulateForestBtn = document.getElementById('simulateForest');
  const resetBtn = document.getElementById('resetBtn');
  const lightningGroup = document.getElementById('lightningGroup');
  const skyFlash = document.getElementById('skyFlash');
  const svgRoot = document.getElementById('scene');

  // Audio context helper for thunder
  let audioCtx = null;

  function ensureAudioContext(){
    if(!audioCtx){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }catch(e){
        audioCtx = null;
      }
    } else if(audioCtx.state === 'suspended'){
      audioCtx.resume().catch(()=>{});
    }
    return audioCtx;
  }

  function playThunderAudio(){
    const ctx = ensureAudioContext();
    if(!ctx) return;
    // Create short rumble using filtered noise + low oscillator
    const now = ctx.currentTime;
    // noise buffer
    const bufferSize = ctx.sampleRate * 1.2;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++){
      data[i] = (Math.random()*2-1) * (1 - i/bufferSize); // fade out
    }
    const white = ctx.createBufferSource();
    white.buffer = buffer;
    const noiseFilter = ctx.createBiquadFilter();
    noiseFilter.type = 'lowpass';
    noiseFilter.frequency.setValueAtTime(800, now);
    noiseFilter.frequency.exponentialRampToValueAtTime(150, now + 1.2);
    const noiseGain = ctx.createGain();
    noiseGain.gain.setValueAtTime(0.9, now);
    noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 1.6);
    white.connect(noiseFilter);
    noiseFilter.connect(noiseGain);
    noiseGain.connect(ctx.destination);

    // low oscillator for thunder body
    const osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(60, now);
    osc.frequency.exponentialRampToValueAtTime(30, now + 1.4);
    const oscGain = ctx.createGain();
    oscGain.gain.setValueAtTime(0.6, now);
    oscGain.gain.exponentialRampToValueAtTime(0.001, now + 1.4);
    // slightly detune for texture
    const osc2 = ctx.createOscillator();
    osc2.type = 'triangle';
    osc2.frequency.setValueAtTime(45, now);
    osc2.frequency.exponentialRampToValueAtTime(25, now + 1.4);
    const osc2Gain = ctx.createGain();
    osc2Gain.gain.setValueAtTime(0.35, now);
    osc2Gain.gain.exponentialRampToValueAtTime(0.001, now + 1.4);

    osc.connect(oscGain);
    osc2.connect(osc2Gain);
    oscGain.connect(ctx.destination);
    osc2Gain.connect(ctx.destination);

    // start and stop
    white.start(now);
    white.stop(now + 1.3);
    osc.start(now);
    osc.stop(now + 1.4);
    osc2.start(now + 0.02);
    osc2.stop(now + 1.4);
  }

  // Helper functions
  function setVolcanoFirstMessage(){
    volcanoText.textContent = 'Vulkan počinje da eruptira – lava izlazi iz kratera.';
  }
  function setVolcanoNextMessage(){
    volcanoText.textContent = 'Okolina je pogođena, drveće gori, putevi su blokirani.';
  }
  function setForestFirstMessage(){
    forestText.textContent = 'Šuma je pogođena erupcijom, drveće se suši i sagoreva.';
  }
  function setForestNextMessage(){
    forestText.textContent = 'Stanje šume se pogoršava, životinje beže.';
  }

  // Volcano click handler (IF: klik na vulkan)
  function onVolcanoClick(){
    // ensure audio context is created on user gesture
    ensureAudioContext();
    state.volcanoClicks++;
    if(state.volcanoClicks === 1){
      // then_first
      setVolcanoFirstMessage();
      flashCrater();
      // quick lightning strike when eruption starts
      triggerLightning();
    } else {
      // then_next sequence (use only first subsequent action in list for now)
      if(!state.lavaActive){
        activateLava();
        setVolcanoNextMessage();
        // start periodic lightning during active eruption
        state.lightningTimer = setInterval(()=> {
          // occasionally produce lightning during eruption
          if(Math.random()>0.6) triggerLightning();
        }, 4200 + Math.random()*3000);
      } else {
        // further clicks can pulse or emphasize
        pulseLava();
        // immediate lightning for dramatic effect
        triggerLightning();
      }
    }
  }

  // Forest click handler (IF: klik na šumu)
  function onForestClick(){
    ensureAudioContext();
    state.forestClicks++;
    if(state.forestClicks === 1){
      // then_first
      setForestFirstMessage();
      highlightForest();
    } else {
      // then_next: add smoke + change text
      if(!state.smokeActive){
        activateSmoke();
        setForestNextMessage();
        // a distant lightning occasionally when smoke is heavy
        setTimeout(()=>{ if(state.smokeActive) triggerLightning(); }, 900);
      } else {
        pulseSmoke();
      }
    }
  }

  // Visual behaviors
  function flashCrater(){
    // small flicker in crater: scale crater ellipse briefly
    const crater = document.querySelector('#volcano ellipse.crater');
    if(!crater) return;
    crater.style.transition = 'transform 0.22s ease';
    crater.style.transformOrigin = '200px 124px';
    crater.style.transform = 'scale(1.06)';
    setTimeout(()=>{ crater.style.transform = 'scale(1)'; }, 220);
  }

  function activateLava(){
    state.lavaActive = true;
    // show lava path
    lavaPath.classList.remove('hidden');
    setTimeout(()=> lavaPath.classList.add('active'), 30);

    // start animating lava drops by adding class and slight offsets
    const drops = lavaDropsGroup.querySelectorAll('.lava-drop');
    drops.forEach((d,i)=>{
      d.classList.add('animate');
      // stagger animation using animationDelay
      d.style.animationDelay = (i*0.33)+'s';
      // position them initially near crater
      d.setAttribute('cx', 220 + (i*6));
      d.setAttribute('cy', 150 + (i*4));
    });

    // visual emphasis on mountain (shake a little)
    const mount = document.querySelector('#volcano .volcano-base');
    mount.style.transition = 'transform 0.4s ease';
    mount.style.transformOrigin = '200px 220px';
    mount.style.transform = 'translateY(-3px)';
    setTimeout(()=> mount.style.transform = 'translateY(0px)', 420);

    // dramatic lightning + thunder when lava starts flowing
    setTimeout(()=>{ triggerLightning(); }, 220);
  }

  function pulseLava(){
    // small pulse via filter or transform
    lavaPath.style.transition = 'filter 0.25s ease, transform 0.25s ease';
    lavaPath.style.filter = 'brightness(1.15)';
    lavaPath.style.transform = 'scaleY(1.02)';
    setTimeout(()=>{ lavaPath.style.filter=''; lavaPath.style.transform='scaleY(1)'; }, 260);
  }

  function highlightForest(){
    // briefly change tree leaf color to browner to simulate scorching
    const leaves = document.querySelectorAll('.tree-leaf');
    leaves.forEach((leaf,i)=>{
      setTimeout(()=>{
        leaf.style.transition = 'fill 1.2s ease';
        leaf.style.fill = '#7b5c2b'; // scorched
      }, i*50);
    });
  }

  // Create smoke shapes and animate
  function activateSmoke(){
    state.smokeActive = true;
    // build 3 smoke puffs with varying sizes and speeds
    forestSmokeGroup.innerHTML = '';
    const puffs = [
      {cx:20, cy:20, r:18, cls:'smoke rising'},
      {cx:40, cy:30, r:14, cls:'smoke rising slow'},
      {cx:10, cy:35, r:10, cls:'smoke rising'}
    ];
    puffs.forEach((p, idx)=>{
      const c = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
      c.setAttribute('cx', p.cx);
      c.setAttribute('cy', p.cy);
      c.setAttribute('rx', p.r);
      c.setAttribute('ry', Math.round(p.r*0.6));
      c.setAttribute('class', p.cls);
      c.style.opacity = 0;
      forestSmokeGroup.appendChild(c);
      // small delay to stagger appearance
      setTimeout(()=>{ c.classList.add('visible'); }, idx*150);
    });

    // also darken nearby trees more
    const leaves = document.querySelectorAll('#forestLeft .tree-leaf');
    leaves.forEach((leaf,i)=>{
      setTimeout(()=>{
        leaf.style.transition = 'fill 1.2s ease, opacity 1s';
        leaf.style.fill = '#5a4a2a';
        leaf.style.opacity = 0.9;
      }, i*80);
    });
  }

  function pulseSmoke(){
    const smokes = forestSmokeGroup.querySelectorAll('.smoke');
    smokes.forEach((s,i)=>{
      s.style.transition = 'transform 0.35s ease, opacity 0.3s ease';
      s.style.transform = 'translateY(-6px) scale(1.02)';
      s.style.opacity = 0.8;
      setTimeout(()=>{ s.style.transform='translateY(0) scale(1)'; s.style.opacity='0.95'; }, 350 + i*40);
    });
  }

  function resetScene(){
    // Reset state flags and remove animations/effects
    state.volcanoClicks = 0;
    state.forestClicks = 0;
    state.lavaActive = false;
    state.smokeActive = false;
    if(state.lightningTimer){ clearInterval(state.lightningTimer); state.lightningTimer = null; }

    // Reset panels text
    volcanoText.textContent = 'Kliknite na vulkan da biste započeli simulaciju erupcije.';
    forestText.textContent = 'Kliknite na šumu da biste videli kako erupcija utiče na okolnu vegetaciju.';

    // hide lava
    lavaPath.classList.remove('active');
    lavaPath.classList.add('hidden');
    // remove any transforms/filters and drop animations
    const drops = lavaDropsGroup.querySelectorAll('.lava-drop');
    drops.forEach((d)=>{
      d.classList.remove('animate');
      d.style.animationDelay = '';
    });

    // clear smoke
    forestSmokeGroup.innerHTML = '';

    // clear lightning
    if(lightningGroup) lightningGroup.innerHTML = '';
    skyFlash.style.opacity = 0;
    skyFlash.style.animation = '';

    // restore tree colors and opacity
    const allLeaves = document.querySelectorAll('.tree-leaf');
    allLeaves.forEach((leaf)=>{
      leaf.style.transition = 'fill 0.6s ease, opacity 0.4s ease';
      leaf.style.fill = getComputedStyle(document.documentElement).getPropertyValue('--forest') || '#228B22';
      leaf.style.opacity = 1;
    });

    // small reset of volcano crater transform if any
    const crater = document.querySelector('#volcano ellipse.crater');
    if(crater) crater.style.transform = '';

    // small reset for volcano base
    const mount = document.querySelector('#volcano .volcano-base');
    if(mount) mount.style.transform = '';
  }

  // Lightning creation and animation
  function createBoltPath(xStart, yStart, segments, segmentLength, direction){
    const pts = [[xStart,yStart]];
    let x = xStart, y = yStart;
    for(let i=0;i<segments;i++){
      const dx = (Math.random()*0.6 + 0.2) * segmentLength * (direction === 'left' ? -1 : 1);
      const dy = (Math.random()*0.8 + 0.8) * segmentLength;
      x += dx;
      y += dy;
      pts.push([Math.round(x), Math.round(y)]);
    }
    // build path string zigzag
    let d = `M ${pts[0][0]} ${pts[0][1]}`;
    for(let i=1;i<pts.length;i++){
      d += ` L ${pts[i][0]} ${pts[i][1]}`;
    }
    return d;
  }

  function triggerLightning(){
    // Create one bolt and flash + sound
    if(!lightningGroup) return;
    // randomize start position in upper sky
    const startX = 220 + Math.random()*460; // between 220 and 680
    const startY = 30 + Math.random()*40; // high in sky
    const segments = 6 + Math.floor(Math.random()*4);
    const segmentLength = 18 + Math.random()*14;
    const dir = (Math.random()>0.5) ? 'left' : 'right';
    const pathD = createBoltPath(startX, startY, segments, segmentLength, dir);

    const bolt = document.createElementNS('http://www.w3.org/2000/svg','path');
    bolt.setAttribute('d', pathD);
    bolt.setAttribute('class', 'lightning-bolt');
    // subtle color variations
    bolt.style.stroke = (Math.random()>0.6) ? '#ffffff' : '#fff6c8';
    lightningGroup.appendChild(bolt);

    // flash the sky quickly
    skyFlash.style.animation = 'lightningFlicker 520ms linear';
    skyFlash.style.opacity = 0.95;
    // small timeout to clear animation after done
    setTimeout(()=>{ skyFlash.style.animation = ''; skyFlash.style.opacity = 0; }, 520);

    // rapidly toggle bolt visibility to simulate flicker
    setTimeout(()=>{ bolt.classList.add('flash'); }, 10);
    setTimeout(()=>{ bolt.classList.remove('flash'); }, 120);
    setTimeout(()=>{ bolt.classList.add('flash'); }, 180);
    setTimeout(()=>{ bolt.classList.remove('flash'); }, 260);

    // remove bolt after a bit
    setTimeout(()=>{ try{ lightningGroup.removeChild(bolt); }catch(e){} }, 800);

    // play thunder audio slightly delayed to mimic distance (short delay)
    setTimeout(()=>{ playThunderAudio(); }, 120 + Math.random()*700);
  }

  // Attach event listeners
  volcanoGroup.addEventListener('click', onVolcanoClick);
  forestLeft.addEventListener('click', onForestClick);
  forestRight.addEventListener('click', onForestClick); // both forests respond similarly

  simulateVolcanoBtn.addEventListener('click', onVolcanoClick);
  simulateForestBtn.addEventListener('click', onForestClick);
  resetBtn.addEventListener('click', resetScene);

  // Initialize: ensure lava hidden, no smoke
  resetScene();

  // Accessibility: keyboard interactions for volcano and forest
  volcanoGroup.setAttribute('tabindex','0');
  volcanoGroup.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); onVolcanoClick(); }});
  forestLeft.setAttribute('tabindex','0');
  forestLeft.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); onForestClick(); }});
  forestRight.setAttribute('tabindex','0');
  forestRight.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); onForestClick(); }});

  // Extra: gentle ambient animation - subtle cloud movement using SVG transform
  let cloudOffset = 0;
  setInterval(()=> {
    cloudOffset = (cloudOffset + 0.4) % 900;
    // move hills group slightly to create parallax
    const hills = document.getElementById('hills');
    if(hills) hills.setAttribute('transform', `translate(${Math.sin(Date.now()/3000)*6},0)`);
  }, 60);

  // Clean up when leaving page: stop audio context if exists
  window.addEventListener('pagehide', ()=>{ if(audioCtx && audioCtx.state !== 'closed') audioCtx.close().catch(()=>{}); });

})();
</script>

</body></html>