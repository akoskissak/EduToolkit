<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="utf-8" />
<title>Gde da izgradimo grad?</title>
<style>
  /* audience: osnovna škola */
  body{font-family:Segoe UI, Roboto, Arial, sans-serif;margin:0;background:#f3f6f9;color:#1b2b34}
  header{padding:18px 24px;background:linear-gradient(90deg,#3b82f6,#06b6d4);color:white}
  h1{margin:0;font-size:24px}
  .container{display:flex;gap:12px;padding:18px}
  .left{flex:1;min-width:520px;background:linear-gradient(#ffffff,#eef6ff);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(11,22,50,0.08)}
  .intro{margin:0 0 8px 0;padding:8px 12px;border-radius:6px;background:rgba(255,255,255,0.6);font-size:14px;color:#07324a}
  .canvas-wrap{background:#dbeeff;border-radius:8px;padding:8px;display:flex;justify-content:center;align-items:center}
  svg{width:100%;height:420px;display:block;border-radius:6px;overflow:visible}
  .region{cursor:pointer;transition:filter .18s,opacity .18s}
  .region:hover{filter:brightness(.95) drop-shadow(0 6px 10px rgba(0,0,0,0.12))}
  .right{width:300px;min-width:260px;background:white;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(11,22,50,0.06);display:flex;flex-direction:column;gap:12px}
  .panel-title{font-weight:700;color:#07324a;margin:0 0 6px 0}
  .panel-text{flex:1;background:linear-gradient(#ffffff,#fbfdff);padding:12px;border-radius:8px;border:1px solid #eef3f8;color:#0b2a3a;min-height:120px}
  .panel-text p{margin:0;font-size:14px;line-height:1.4}
  .controls{display:flex;gap:8px;align-items:center}
  button{background:#0ea5a4;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 6px 12px rgba(14,165,164,0.14)}
  button.secondary{background:#f3f4f6;color:#0b2a3a;box-shadow:none;border:1px solid #e6eef5}
  .legend{display:flex;gap:8px;align-items:center;font-size:13px;color:#0b2a3a}
  .legend .sw{width:14px;height:14px;border-radius:3px;display:inline-block;margin-right:8px}
  /* small helper */
  .muted{color:#235;opacity:.7}
  /* responsive */
  @media (max-width:920px){.container{flex-direction:column}.left{min-width:auto}.right{width:100%}}
</style>
</head>
<body>
  <header>
    <h1>Gde da izgradimo grad?</h1>
  </header>

  <div class="container">
    <div class="left">
      <p class="intro">Izaberi oblast da vidiš mogućnosti razvoja grada</p>

      <div class="canvas-wrap">
        <svg id="mapSvg" viewBox="0 0 700 420" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" aria-label="Interaktivna mapa">
          <!-- Background terrain -->
          <defs>
            <linearGradient id="riverGrad" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#7dd3fc" stop-opacity="0.9"/>
              <stop offset="100%" stop-color="#38bdf8" stop-opacity="0.6"/>
            </linearGradient>
            <linearGradient id="forestGrad" x1="0" x2="1">
              <stop offset="0%" stop-color="#86efac"/>
              <stop offset="100%" stop-color="#16a34a"/>
            </linearGradient>
            <linearGradient id="mountGrad" x1="0" x2="1">
              <stop offset="0%" stop-color="#c7c7c7"/>
              <stop offset="100%" stop-color="#9ca3af"/>
            </linearGradient>
            <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="6" stdDeviation="10" flood-color="#000" flood-opacity="0.08"/>
            </filter>
            <clipPath id="forestClip">
              <rect x="420" y="60" width="250" height="260" rx="18" ry="18"/>
            </clipPath>
          </defs>

          <!-- gentle hills background -->
          <g id="hills" opacity="0.6">
            <path d="M0 320 Q70 250 150 300 T350 300 T550 290 T700 300 L700 420 L0 420 Z" fill="#e6f4ea"/>
          </g>

          <!-- River path (clickable region) -->
          <g id="riverGroup" class="region" data-id="river" aria-label="Reka">
            <path id="riverPath" d="M0 320 C80 290 150 330 230 310 C300 295 380 320 460 305 C520 295 580 320 700 300 L700 420 L0 420 Z" fill="url(#riverGrad)" stroke="#2b8dd6" stroke-width="2" />
            <!-- accent waves -->
            <path d="M30 335 Q85 305 150 330" stroke="#cbeaff" stroke-width="2.2" fill="none" opacity="0.7"/>
            <path d="M220 328 Q300 303 380 325" stroke="#cbeaff" stroke-width="2.2" fill="none" opacity="0.6"/>
            <!-- boat placeholder (hidden until animation) -->
            <g id="boat" transform="translate(-100,-100)" opacity="0.0">
              <rect x="-8" y="-4" width="18" height="8" fill="#8b5cf6" rx="2"/>
              <polygon points="-8,-4 10,-4 2,-12" fill="#ffffff" opacity="0.9"/>
            </g>
          </g>

          <!-- Mountain region (left) -->
          <g id="mountainGroup" class="region" data-id="mountain" transform="translate(40,20)" aria-label="Planina">
            <g id="mountains" >
              <polygon points="0,240 60,120 130,240" fill="url(#mountGrad)" stroke="#767676" stroke-width="2"/>
              <polygon points="90,240 150,80 230,240" fill="#bfc3c7" stroke="#8b9096" stroke-width="2"/>
              <polygon points="40,240 0,180 90,240" fill="#d9d9d9" opacity="0.95"/>
            </g>
            <!-- mines/rudnik entrance -->
            <rect id="mineEntrance" x="40" y="200" width="28" height="18" fill="#3f3f3f" rx="4" />
            <!-- smoke container -->
            <g id="smokeLayer"></g>
          </g>

          <!-- Forest region (right) -->
          <g id="forestGroup" class="region" data-id="forest" aria-label="Šuma">
            <rect x="420" y="60" width="250" height="260" fill="url(#forestGrad)" rx="18" ry="18" stroke="#146c43" stroke-width="2" opacity="0.95"/>
            <g id="trees" clip-path="url(#forestClip)" transform="translate(420,60)">
              <!-- several stylized trees -->
              <g transform="translate(30,40)">
                <rect x="18" y="80" width="8" height="26" fill="#5b3a21"/>
                <circle cx="22" cy="64" r="24" fill="#087f2a"/>
              </g>
              <g transform="translate(80,20)">
                <rect x="18" y="80" width="8" height="26" fill="#5b3a21"/>
                <circle cx="22" cy="64" r="26" fill="#0b8f35"/>
              </g>
              <g transform="translate(140,90)">
                <rect x="18" y="80" width="8" height="26" fill="#5b3a21"/>
                <circle cx="22" cy="64" r="22" fill="#0b8f35"/>
              </g>
              <g transform="translate(200,40)">
                <rect x="18" y="80" width="8" height="26" fill="#5b3a21"/>
                <circle cx="22" cy="64" r="26" fill="#087f2a"/>
              </g>
              <g id="lumberjack" transform="translate(110,140)" opacity="0.0">
                <rect x="0" y="0" width="14" height="20" fill="#6b7280" rx="3"/>
                <rect x="12" y="6" width="14" height="4" fill="#8b5a2b" rx="2" transform="rotate(-25,12,6)"/>
              </g>
            </g>
          </g>

          <!-- map frame/labels -->
          <g id="mapLabels" font-size="12" fill="#07324a" font-weight="700">
            <text x="30" y="60">Planina</text>
            <text x="430" y="50">Šuma</text>
            <text x="30" y="360">Reka</text>
          </g>
        </svg>
      </div>
    </div>

    <aside class="right" role="complementary" aria-label="Panel sa opisima">
      <div>
        <div class="panel-title">Mogućnosti razvoja</div>
        <div class="legend">
          <span class="sw" style="background:#38bdf8"></span><span class="muted">Reka</span>
          <span class="sw" style="background:#c7c7c7;margin-left:10px"></span><span class="muted">Planina</span>
          <span class="sw" style="background:#16a34a;margin-left:10px"></span><span class="muted">Šuma</span>
        </div>
      </div>

      <div class="panel-text" id="infoPanel">
        <p id="panelContent">Izaberi oblast na mapi da vidiš kratki opis i mogućnosti razvoja.</p>
      </div>

      <div class="controls">
        <button id="resetBtn" class="secondary">Izaberi drugu oblast</button>
        <button id="zoomOutBtn">Povratak na celu mapu</button>
      </div>
    </aside>
  </div>

<script>
(function(){
  // Data-driven setup reflecting JSON content
  const interactions = {
    river: {
      then_first: "Grad pored reke – razvijeno ribarstvo, transport i trgovina. Nedostatak: drvo i kamen.",
      then_next: [
        "Luka se razvija, ali nema dovoljno materijala za velike građevine."
      ]
    },
    mountain: {
      then_first: "Planinski grad – dostupni su kamenolomi i rudnici. Nedostatak: voda i plodno zemljište.",
      then_next: [
        "Industrija raste, ali razvoj je ograničen usled nepovoljnih uslova za poljoprivredu."
      ]
    },
    forest: {
      then_first: "Šumski grad – dostupno drvo i lov, ali nedostaju kamen i trgovačke rute.",
      then_next: [
        "Grad raste sporo zbog loših veza sa ostalim oblastima."
      ]
    }
  };

  // State
  const counts = {river:0,mountain:0,forest:0};
  const svg = document.getElementById('mapSvg');
  const panelContent = document.getElementById('panelContent');
  const resetBtn = document.getElementById('resetBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');

  const boat = document.getElementById('boat');
  const riverPath = document.getElementById('riverPath');
  const smokeLayer = document.getElementById('smokeLayer');
  const lumberjack = document.getElementById('lumberjack');
  const forestGroup = document.getElementById('forestGroup');
  const mountainGroup = document.getElementById('mountainGroup');
  const riverGroup = document.getElementById('riverGroup');

  // ViewBox control
  let currentView = {x:0,y:0,w:700,h:420};
  const defaultView = {...currentView};
  let animatingView = false;

  // Animation flags
  let boatActive = false;
  let boatStart = performance.now();
  let boatSpeed = 0.00006; // fraction per ms
  let smokeActive = false;
  let lumberActive = false;
  let smokeParticles = [];
  let rafId;

  // Utility helpers
  function setPanel(text){
    panelContent.innerText = text;
  }

  function getBBoxForElement(elem){
    try{
      return elem.getBBox();
    }catch(e){
      // fallback
      return {x:0,y:0,width:100,height:100};
    }
  }

  function animateViewBoxTo(target, duration=600){
    if(animatingView) return;
    animatingView = true;
    const start = {...currentView};
    const startTime = performance.now();
    function step(now){
      const t = Math.min(1,(now - startTime)/duration);
      const ease = t*(2-t);
      currentView.x = start.x + (target.x - start.x)*ease;
      currentView.y = start.y + (target.y - start.y)*ease;
      currentView.w = start.w + (target.w - start.w)*ease;
      currentView.h = start.h + (target.h - start.h)*ease;
      svg.setAttribute('viewBox', `${currentView.x} ${currentView.y} ${currentView.w} ${currentView.h}`);
      if(t<1) requestAnimationFrame(step); else animatingView = false;
    }
    requestAnimationFrame(step);
  }

  function focusOnElement(elem){
    const bbox = getBBoxForElement(elem);
    // expand a bit
    const padW = bbox.width * 0.6 + 50;
    const padH = bbox.height * 0.6 + 30;
    const tx = bbox.x - padW*0.1;
    const ty = bbox.y - padH*0.12;
    const tw = bbox.width + padW;
    const th = bbox.height + padH;
    const target = {x:tx,y:ty,w:tw,h:th};
    animateViewBoxTo(target);
  }

  function resetView(){
    animateViewBoxTo(defaultView);
    // also clear counts and animations
    stopBoat();
    stopSmoke();
    stopLumber();
    counts.river = counts.mountain = counts.forest = 0;
    setPanel("Izaberi oblast na mapi da vidiš kratki opis i mogućnosti razvoja.");
    // hide any highlights
    riverGroup.style.opacity = 1;
    mountainGroup.style.opacity = 1;
    forestGroup.style.opacity = 1;
  }

  // Boat animation along river path
  const pathLength = riverPath.getTotalLength();
  function startBoat(){
    if(boatActive) return;
    boatActive = true;
    boatStart = performance.now();
    boat.style.opacity = 1;
    // ensure visible by setting initial attributes
    function animate(now){
      if(!boatActive) return;
      const elapsed = now - boatStart;
      // loop t between 0..1
      const t = (elapsed * boatSpeed) % 1;
      const pos = riverPath.getPointAtLength(t * pathLength);
      // compute slight heading using forward sample
      const ahead = riverPath.getPointAtLength(((t*pathLength)+6) % pathLength);
      const angle = Math.atan2(ahead.y - pos.y, ahead.x - pos.x) * 180/Math.PI;
      boat.setAttribute('transform', `translate(${pos.x},${pos.y}) rotate(${angle})`);
      rafId = requestAnimationFrame(animate);
    }
    rafId = requestAnimationFrame(animate);
  }
  function stopBoat(){
    boatActive = false;
    boat.style.opacity = 0;
    if(rafId) cancelAnimationFrame(rafId);
  }

  // Smoke animation for mountain
  function startSmoke(){
    if(smokeActive) return;
    smokeActive = true;
    smokeParticles = [];
    spawnSmoke();
  }
  function spawnSmoke(){
    if(!smokeActive) return;
    const now = performance.now();
    const p = {
      id: 's'+now,
      x: 70 + Math.random()*30,
      y: 170 + Math.random()*8,
      r: 6 + Math.random()*6,
      life: 2000 + Math.random()*1200,
      born: now,
      alpha: 0.9
    };
    smokeParticles.push(p);
    drawSmoke();
    // spawn more
    setTimeout(spawnSmoke, 400 + Math.random()*500);
  }
  function drawSmoke(){
    // clear
    while (smokeLayer.firstChild) smokeLayer.removeChild(smokeLayer.firstChild);
    const now = performance.now();
    smokeParticles = smokeParticles.filter(p => (now - p.born) < p.life);
    smokeParticles.forEach(p=>{
      const t = (now - p.born)/p.life;
      const ny = p.y - t*60;
      const nr = p.r + t*10;
      const na = Math.max(0, p.alpha * (1 - t));
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', p.x);
      c.setAttribute('cy', ny);
      c.setAttribute('r', nr);
      c.setAttribute('fill', '#cbd5e1');
      c.setAttribute('opacity', na);
      smokeLayer.appendChild(c);
    });
    if(smokeActive) requestAnimationFrame(drawSmoke);
  }
  function stopSmoke(){
    smokeActive = false;
    smokeParticles = [];
    while (smokeLayer.firstChild) smokeLayer.removeChild(smokeLayer.firstChild);
  }

  // Lumberjack animation
  let lumberTick = 0;
  function startLumber(){
    if(lumberActive) return;
    lumberActive = true;
    lumberjack.style.opacity = 1;
    lumberTick = performance.now();
    function animate(now){
      if(!lumberActive) return;
      const t = (now - lumberTick)/180;
      const sway = Math.sin(t)*6;
      // rotate axe (child rect)
      const axe = lumberjack.querySelector('rect:nth-child(2)');
      axe.setAttribute('transform', `rotate(${ -25 + sway },12,6)`);
      lumberjack.setAttribute('transform', `translate(110,140) translate(${Math.sin(t/2)*4},${Math.abs(Math.sin(t))*2})`);
      rafId = requestAnimationFrame(animate);
    }
    rafId = requestAnimationFrame(animate);
  }
  function stopLumber(){
    lumberActive = false;
    lumberjack.style.opacity = 0;
    // reset transforms
    lumberjack.setAttribute('transform','translate(110,140)');
    const axe = lumberjack.querySelector('rect:nth-child(2)');
    if(axe) axe.setAttribute('transform','rotate(-25,12,6)');
    if(rafId) cancelAnimationFrame(rafId);
  }

  // Click handling
  function handleRegionClick(regionId){
    counts[regionId] += 1;
    const c = counts[regionId];
    const config = interactions[regionId];
    if(c === 1){
      // first action
      setPanel(config.then_first);
      // highlight selected
      highlightRegion(regionId);
      // zoom to element
      if(regionId === 'river') focusOnElement(riverGroup);
      if(regionId === 'mountain') focusOnElement(mountainGroup);
      if(regionId === 'forest') focusOnElement(forestGroup);
      // animations not started yet for first click
      // optional small visuals: gentle pulse
      pulseRegion(regionId);
    } else {
      // then_next sequence - index cycles
      const index = (c - 2) % config.then_next.length;
      setPanel(config.then_next[index]);
      // start associated animation and additional visuals
      if(regionId === 'river'){
        startBoat();
        // small delay ensure boat visible
        boat.style.opacity = 1;
      } else if(regionId === 'mountain'){
        startSmoke();
      } else if(regionId === 'forest'){
        startLumber();
      }
      // focus more tightly when animation begins
      if(regionId === 'river') focusOnElement(riverGroup);
      if(regionId === 'mountain') focusOnElement(mountainGroup);
      if(regionId === 'forest') focusOnElement(forestGroup);
    }
  }

  function pulseRegion(regionId){
    const el = regionId==='river' ? riverGroup : regionId==='mountain' ? mountainGroup : forestGroup;
    el.animate([{transform:'scale(1)'},{transform:'scale(1.02)'}], {duration:280,iterations:2,direction:'alternate',easing:'ease-out'});
  }

  function highlightRegion(regionId){
    // dim others
    riverGroup.style.opacity = regionId==='river' ? 1 : 0.6;
    mountainGroup.style.opacity = regionId==='mountain' ? 1 : 0.6;
    forestGroup.style.opacity = regionId==='forest' ? 1 : 0.6;
  }

  // Attach listeners
  riverGroup.addEventListener('click', ()=> handleRegionClick('river'));
  mountainGroup.addEventListener('click', ()=> handleRegionClick('mountain'));
  forestGroup.addEventListener('click', ()=> handleRegionClick('forest'));

  // Reset / zoom out buttons
  resetBtn.addEventListener('click', (e)=> {
    e.preventDefault();
    resetView();
  });
  zoomOutBtn.addEventListener('click', (e)=> {
    e.preventDefault();
    resetView();
  });

  // Initialize viewBox default
  svg.setAttribute('viewBox', `${defaultView.x} ${defaultView.y} ${defaultView.w} ${defaultView.h}`);

  // Keyboard accessibility: allow Enter/Space on regions
  [riverGroup, mountainGroup, forestGroup].forEach(g=>{
    g.setAttribute('tabindex','0');
    g.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){
        const id = g.dataset.id;
        handleRegionClick(id);
      }
    });
  });

  // Start a light ambient animation loop for subtle map life (swaying trees)
  (function ambientLoop(){
    const trees = document.querySelectorAll('#trees circle');
    let t0 = 0;
    function tick(now){
      if(!t0) t0 = now;
      const dt = (now - t0)/1500;
      trees.forEach((c,i)=>{
        const s = 1 + Math.sin(dt + i)*0.01;
        c.setAttribute('transform', `scale(${s})`);
      });
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  })();

  // Clean up on page unload
  window.addEventListener('unload', ()=>{
    stopBoat(); stopSmoke(); stopLumber();
  });

  // Expose some debugging on global (not required)
  window._mapTool = {resetView};

})();
</script>
</body>
</html>