<html lang="sr"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Život u reci</title>
<style>
  /* audience: osnovna škola, biologija */
  :root{
    --bg:#e8f5ff;
    --river:#4db6ff;
    --bank:#7fbf6f;
    --panel-bg: rgba(255,255,255,0.98);
    --panel-border: #2c6b4b;
    --btn:#2b7cff;
  }
  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 10% 10%, #dff6ff 0%, transparent 20%), linear-gradient(#ccf0ff, #e9fff6 60%);
    color:#063047;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px;
    min-height:100vh;
    box-sizing:border-box;
  }
  header{
    text-align:center;
    margin-bottom:12px;
    filter: drop-shadow(0 6px 12px rgba(6,24,34,0.06));
  }
  h1{
    margin:0;
    font-size:2.2rem;
    letter-spacing:0.6px;
  }
  p.description{
    max-width:900px;
    margin:8px 0 18px;
    font-size:1.05rem;
    line-height:1.5;
    color:#02303a;
  }
  .controls{
    display:flex;
    gap:10px;
    margin-bottom:12px;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
  }
  .controls button{
    background:var(--btn);
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 6px 14px rgba(43,124,255,0.18), inset 0 -2px 0 rgba(0,0,0,0.08);
    transition: transform 0.12s ease, box-shadow 0.12s ease;
  }
  .controls button:active{ transform: translateY(1px); box-shadow:0 4px 10px rgba(43,124,255,0.12); }
  .controls button.secondary{
    background:#2f9f6e;
  }
  .controls .status{
    pointer-events:none;
    background:transparent;
    color:#033;
    font-weight:600;
    padding:10px 8px;
    border-radius:8px;
  }
  #scene{
    width:960px;
    max-width:96vw;
    height:520px;
    border-radius:14px;
    box-shadow:0 18px 40px rgba(6,24,34,0.12);
    background: linear-gradient(#cfeefc, #e8fff4 60%);
    position:relative;
    overflow:hidden;
    border: 1px solid rgba(6,24,34,0.04);
  }
  svg{
    width:100%;
    height:100%;
    display:block;
  }

  /* nicer panels */
  .panel{
    position:absolute;
    background:var(--panel-bg);
    border:2px solid var(--panel-border);
    padding:12px 14px;
    border-radius:12px;
    box-shadow:0 10px 26px rgba(0,0,0,0.12);
    max-width:300px;
    font-size:0.98rem;
    display:none;
    transition: transform 0.18s ease, opacity 0.18s ease;
  }
  .panel h3{
    margin:0 0 8px 0;
    font-size:1.03rem;
  }
  .panel p{margin:0;font-size:0.95rem;color:#07313a;}

  /* fish styles - improved shading */
  .fish{
    transform-origin:center;
    cursor:pointer;
    transition: transform 0.18s ease;
    filter: drop-shadow(0 6px 8px rgba(0,0,0,0.08));
  }
  .fish:hover{ transform: scale(1.04); }
  .fish .body{ fill: #ff9f5a; stroke:#b65f2f; stroke-width:0.9;}
  .fish .eye{ fill:#111;}
  /* plant styles */
  .plant{
    fill:#2ecc71;
    stroke:#12733f;
    stroke-width:1;
    transform-origin: bottom center;
    cursor:pointer;
  }
  .frog{
    cursor:pointer;
    transition: transform 0.12s ease;
    filter: drop-shadow(0 6px 8px rgba(0,0,0,0.08));
  }
  .frog:hover{ transform: translateY(-4px); }
  .frog .body{ fill:#6cd16b; stroke:#2f8f46; stroke-width:0.9;}
  .frog .eye{ fill:#fff; stroke:#000; stroke-width:0.6;}

  /* water ripple/wave animations */
  #river{
    transition: height 0.36s ease, y 0.36s ease;
    filter: url(#riverShadow);
  }

  #ripples ellipse { fill:white; opacity:0.06; transform-origin: 50% 50%; }
  #ripples ellipse.r1 { animation: rippleMove 6.5s linear infinite; }
  #ripples ellipse.r2 { animation: rippleMove 9s linear infinite reverse; opacity:0.05; }
  #ripples ellipse.r3 { animation: rippleMove 7.2s linear infinite; opacity:0.045; }
  @keyframes rippleMove {
    0% { transform: translateX(-10px) scaleX(1) scaleY(1); opacity:0.06; }
    50% { transform: translateX(10px) scaleX(1.03) scaleY(0.98); opacity:0.09; }
    100% { transform: translateX(-10px) scaleX(1) scaleY(1); opacity:0.06; }
  }

  /* subtle wave strokes moving across the river surface */
  .waveStroke{
    fill:none;
    stroke:#ffffff;
    stroke-opacity:0.14;
    stroke-linecap:round;
    stroke-width:6;
    mix-blend-mode: overlay;
    filter: blur(0.6px);
    transform-origin: 50% 50%;
    pointer-events:none;
  }
  .waveStroke.w1{ stroke-width:8; stroke-opacity:0.14; animation: waveFlow 6.2s linear infinite; }
  .waveStroke.w2{ stroke-width:5; stroke-opacity:0.12; animation: waveFlow 8s linear infinite reverse; }
  .waveStroke.w3{ stroke-width:4; stroke-opacity:0.08; animation: waveFlow 10s linear infinite; }
  @keyframes waveFlow {
    0% { transform: translateX(-40px) translateY(0) scaleX(1); opacity:0.9; }
    50% { transform: translateX(40px) translateY(2px) scaleX(1.02); opacity:1; }
    100% { transform: translateX(-40px) translateY(0) scaleX(1); opacity:0.9; }
  }

  /* small shimmering highlights that slowly fade in/out */
  .shine { fill:rgba(255,255,255,0.08); mix-blend-mode: screen; animation: shinePulse 4.8s ease-in-out infinite; }
  @keyframes shinePulse { 0%{opacity:0.6} 50%{opacity:1} 100%{opacity:0.6} }

  /* soft shadows and depths */
  .bankShadow{ fill: rgba(0,0,0,0.06); filter: blur(6px); opacity:0.9; }

  /* fish swim tweaks */
  @keyframes swim {
    0%{ transform: translateX(0) translateY(0) rotate(0deg); }
    50%{ transform: translateX(8px) translateY(-4px) rotate(-2deg);}
    100%{ transform: translateX(0) translateY(0) rotate(0deg);}
  }
  .swim-animation{ animation: swim 2.2s ease-in-out infinite; }
  .swim-fast{ animation-duration:1s; }

  @keyframes flee {
    0%{ transform: translateX(0) scale(1); opacity:1; }
    50%{ transform: translateX(-200px) scale(0.8); opacity:0.6;}
    100%{ transform: translateX(-420px) scale(0.6); opacity:0.2;}
  }
  .flee-left{ animation: flee 1.6s ease-out forwards; }
  @keyframes flee-right {
    0%{ transform: translateX(0) scale(1); opacity:1; }
    50%{ transform: translateX(200px) scale(0.8); opacity:0.6;}
    100%{ transform: translateX(420px) scale(0.6); opacity:0.2;}
  }
  .flee-right{ animation: flee-right 1.6s ease-out forwards; }

  @keyframes grow {
    0%{ transform: scaleY(1) translateY(0); }
    100%{ transform: scaleY(1.6) translateY(-10px); }
  }
  .grow{ animation: grow 2.2s ease-in-out forwards; transform-origin: bottom center; }

  @keyframes hop {
    0%{ transform: translateY(0); }
    25%{ transform: translateY(-28px); }
    50%{ transform: translateY(0); }
    75%{ transform: translateY(-14px); }
    100%{ transform: translateY(0); }
  }
  .hop{ animation: hop 1.1s cubic-bezier(.2,.8,.3,1) forwards; }

  /* small responsive tweaks */
  @media (max-width:640px){
    h1{ font-size:1.6rem; }
    .controls button{ padding:8px 10px; font-size:0.95rem;}
    .panel{ max-width: 88vw; left: 6vw !important; right: 6vw !important;}
  }

</style>
</head>
<body>
  <header>
    <h1>Život u reci</h1>
    <p class="description">Interaktivni alat koji prikazuje biljni i životinjski svet reke i kako promene u vodi utiču na ekosistem.</p>
  </header>

  <div class="controls" aria-hidden="false">
    <button id="waterBtn">Nivo vode: Normal</button>
    <button id="tempBtn" class="secondary">Temperatura: Normal</button>
    <button id="resetBtn">Resetuj</button>
    <div class="status" id="statusText">Ekosistem vraćen u početno stanje.</div>
  </div>

  <div id="scene">
    <svg id="svg" viewBox="0 0 960 520" preserveAspectRatio="xMidYMid meet" aria-label="Scena reke">
      <rect x="0" y="0" width="960" height="520" fill="transparent"></rect>

      <defs>
        <linearGradient id="bankGrad" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="#98e07f"></stop>
          <stop offset="100%" stop-color="#74b86b"></stop>
        </linearGradient>

        <linearGradient id="bankShallow" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="#bff2a6"></stop>
          <stop offset="100%" stop-color="#74b86b"></stop>
        </linearGradient>

        <filter id="riverShadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="8" stdDeviation="18" flood-color="#0b3a4a" flood-opacity="0.07"/>
        </filter>

        <filter id="softEdges" x="-20%" y="-20%" width="140%" height="140%">
          <feGaussianBlur stdDeviation="0.5" result="b"/>
          <feMerge>
            <feMergeNode in="b"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>

      </defs>

      <!-- Left bank -->
      <path id="leftBank" d="M0,360 Q120,320 220,340 L220,520 L0,520 Z" fill="url(#bankGrad)" stroke="#5f9b55" stroke-width="1.2"></path>
      <!-- Soft shadow under left bank -->
      <path class="bankShadow" d="M0,360 Q120,320 220,340 L220,360 Q120,380 0,360 Z" opacity="0.08"></path>

      <!-- Right bank -->
      <path id="rightBank" d="M960,360 Q840,320 740,340 L740,520 L960,520 Z" fill="url(#bankGrad)" stroke="#5f9b55" stroke-width="1.2"></path>
      <path class="bankShadow" d="M960,360 Q840,320 740,340 L740,360 Q840,380 960,360 Z" opacity="0.08"></path>

      <!-- subtle pebbles on banks to look nicer -->
      <g id="pebbles" opacity="0.85">
        <ellipse cx="180" cy="380" rx="6" ry="4" fill="#c2e7c6" opacity="0.6"></ellipse>
        <ellipse cx="162" cy="392" rx="8" ry="5" fill="#d2f0d0" opacity="0.55"></ellipse>
        <ellipse cx="780" cy="394" rx="6" ry="4" fill="#c2e7c6" opacity="0.6"></ellipse>
        <ellipse cx="802" cy="382" rx="9" ry="5" fill="#d2f0d0" opacity="0.55"></ellipse>
      </g>

      <!-- River group with gradient -->
      <g id="riverGroup">
        <defs>
          <linearGradient id="riverGradient" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#79d0ff"></stop>
            <stop offset="40%" stop-color="#66c0ff"></stop>
            <stop offset="100%" stop-color="#2fa6ff"></stop>
          </linearGradient>
        </defs>

        <rect id="river" x="200" y="160" width="560" height="240" rx="24" fill="url(#riverGradient)"></rect>

        <!-- gentle ripples - animated later by CSS -->
        <g id="ripples" opacity="0.30" pointer-events="none">
          <ellipse class="r1" cx="480" cy="230" rx="240" ry="26" fill="white" opacity="0.06"></ellipse>
          <ellipse class="r2" cx="520" cy="300" rx="200" ry="18" fill="white" opacity="0.05"></ellipse>
          <ellipse class="r3" cx="420" cy="280" rx="160" ry="12" fill="white" opacity="0.04"></ellipse>
        </g>

        <!-- wave strokes overlay for moving surface waves -->
        <g id="waveOverlay" pointer-events="none" style="mix-blend-mode: overlay;">
          <path class="waveStroke w1" d="M220 200 C320 210, 420 230, 520 220 C620 210, 720 230, 820 220" transform="translate(0,6)"></path>
          <path class="waveStroke w2" d="M220 240 C320 250, 420 270, 520 260 C620 250, 720 270, 820 260" transform="translate(0,8)"></path>
          <path class="waveStroke w3" d="M220 280 C320 290, 420 310, 520 300 C620 290, 720 310, 820 300" transform="translate(0,10)"></path>

          <!-- shimmer highlight -->
          <ellipse class="shine" cx="520" cy="205" rx="120" ry="22" opacity="0.28"></ellipse>
          <ellipse class="shine" cx="440" cy="295" rx="90" ry="14" opacity="0.18"></ellipse>
        </g>

      </g>

      <!-- Plants along banks (group clickable) -->
      <g id="plantsGroup" transform="translate(0,0)" style="cursor:pointer" title="Kliknite na vodene biljke">
        <!-- left plants -->
        <g id="plantsLeft" transform="translate(60,345)">
          <path class="plant" d="M10,30 C18,10 8,2 10,0 C12,2 2,8 10,30 Z" transform="scale(1.4)" style=""></path>
          <path class="plant" d="M40,30 C48,10 38,2 40,0 C42,2 32,8 40,30 Z" transform="scale(1.1) translate(-6,0)" style=""></path>
        </g>
        <!-- right plants -->
        <g id="plantsRight" transform="translate(820,345)">
          <path class="plant" d="M10,30 C18,10 8,2 10,0 C12,2 2,8 10,30 Z" transform="scale(1.2)" style=""></path>
          <path class="plant" d="M40,30 C48,10 38,2 40,0 C42,2 32,8 40,30 Z" transform="scale(1.0) translate(-6,0)" style=""></path>
        </g>
        <!-- riverside plants -->
        <g id="plantsNearRiver" transform="translate(260,380)">
          <path class="plant" d="M10,30 C18,10 8,2 10,0 C12,2 2,8 10,30 Z" transform="scale(1.6)" style=""></path>
          <path class="plant" d="M60,30 C68,10 58,2 60,0 C62,2 52,8 60,30 Z" transform="scale(1.2) translate(-8,0)" style=""></path>
          <path class="plant" d="M140,30 C148,10 138,2 140,0 C142,2 132,8 140,30 Z" transform="scale(1.4) translate(-36,0)" style=""></path>
        </g>
      </g>

      <!-- Fish group in middle of river -->
      <g id="fishGroup" transform="translate(0,0)" style="cursor:pointer" title="Kliknite na ribe">
        <!-- fish 1 -->
        <g class="fish swim-animation" id="fish1" transform="translate(420,220)" style="opacity: 1;">
          <ellipse class="body" cx="0" cy="0" rx="26" ry="14" fill="#ff9f5a"></ellipse>
          <polygon class="body" points="-26,0 -44,-10 -44,10"></polygon>
          <circle class="eye" cx="8" cy="-3" r="3"></circle>
        </g>
        <!-- fish 2 -->
        <g class="fish swim-animation" id="fish2" transform="translate(520,260) scale(-1,1)" style="opacity: 1;">
          <ellipse class="body" cx="0" cy="0" rx="22" ry="12" fill="#ff9f5a"></ellipse>
          <polygon class="body" points="-22,0 -38,-8 -38,8"></polygon>
          <circle class="eye" cx="-8" cy="-3" r="2.6"></circle>
        </g>
        <!-- fish 3 -->
        <g class="fish swim-animation" id="fish3" transform="translate(480,200) scale(1,1)" style="opacity: 1;">
          <ellipse class="body" cx="0" cy="0" rx="20" ry="11" fill="#ff9f5a"></ellipse>
          <polygon class="body" points="-20,0 -36,-7 -36,7"></polygon>
          <circle class="eye" cx="6" cy="-2.6" r="2.6"></circle>
        </g>
        <!-- small fish group for population -->
        <g id="smallFishes" transform="translate(360,250)">
          <g class="fish swim-animation smallFish" transform="translate(0,0) scale(0.7)" style="opacity: 1;">
            <ellipse class="body" cx="0" cy="0" rx="12" ry="6" fill="#ff9f5a"></ellipse>
            <polygon class="body" points="-12,0 -20,-5 -20,5"></polygon>
            <circle class="eye" cx="4" cy="-1.5" r="1.4"></circle>
          </g>
          <g class="fish swim-animation smallFish" transform="translate(40,-18) scale(-0.7,0.7)" style="opacity: 1;">
            <ellipse class="body" cx="0" cy="0" rx="11" ry="5.5" fill="#ff9f5a"></ellipse>
            <polygon class="body" points="-11,0 -18,-5 -18,5"></polygon>
            <circle class="eye" cx="-3" cy="-1" r="1.2"></circle>
          </g>
        </g>
      </g>

      <!-- Amphibians on right bank -->
      <g id="frogsGroup" transform="translate(780,360)" style="cursor:pointer" title="Kliknite na vodozemce">
        <g class="frog" id="frog1" transform="translate(-40,20)">
          <ellipse class="body" cx="0" cy="0" rx="16" ry="12"></ellipse>
          <circle class="eye" cx="-6" cy="-8" r="4"></circle>
          <circle class="eye" cx="6" cy="-8" r="4"></circle>
        </g>
        <g class="frog" id="frog2" transform="translate(-4,18)">
          <ellipse class="body" cx="0" cy="0" rx="18" ry="13"></ellipse>
          <circle class="eye" cx="-6" cy="-9" r="4"></circle>
          <circle class="eye" cx="6" cy="-9" r="4"></circle>
        </g>
        <g class="frog" id="frog3" transform="translate(36,20)">
          <ellipse class="body" cx="0" cy="0" rx="14" ry="11"></ellipse>
          <circle class="eye" cx="-4" cy="-7" r="3.5"></circle>
          <circle class="eye" cx="4" cy="-7" r="3.5"></circle>
        </g>
      </g>
    </svg>

    <!-- Panels -->
    <div class="panel" id="fishPanel" style="left: 320px; top: 80px; display: none;">
      <h3>Ribe</h3>
      <p id="fishPanelText">Kliknite na ribe za informaciju.</p>
    </div>

    <div class="panel" id="plantsPanel" style="right: 18px; top: 140px; display: none;">
      <h3>Vodene biljke</h3>
      <p id="plantsPanelText">Kliknite na biljke za informaciju.</p>
    </div>

    <div class="panel" id="frogsPanel" style="left: 640px; top: 60px; display: none;">
      <h3>Vodozemci</h3>
      <p id="frogsPanelText">Kliknite na vodozemce za informaciju.</p>
    </div>

  </div>

<script>
(function(){
  // Elements
  const fishGroup = document.getElementById('fishGroup');
  const plantsGroup = document.getElementById('plantsGroup');
  const frogsGroup = document.getElementById('frogsGroup');

  const fishPanel = document.getElementById('fishPanel');
  const fishPanelText = document.getElementById('fishPanelText');
  const plantsPanel = document.getElementById('plantsPanel');
  const plantsPanelText = document.getElementById('plantsPanelText');
  const frogsPanel = document.getElementById('frogsPanel');
  const frogsPanelText = document.getElementById('frogsPanelText');

  const waterBtn = document.getElementById('waterBtn');
  const tempBtn = document.getElementById('tempBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusText = document.getElementById('statusText');

  const river = document.getElementById('river');
  const leftBank = document.getElementById('leftBank');
  const rightBank = document.getElementById('rightBank');

  // fish elements list
  const fishEls = Array.from(document.querySelectorAll('.fish'));
  const smallFishes = Array.from(document.querySelectorAll('.smallFish'));
  const plantEls = Array.from(document.querySelectorAll('.plant'));
  const frogEls = Array.from(document.querySelectorAll('.frog'));

  // State trackers (click counts)
  let clickCounts = {
    fish: 0,
    plants: 0,
    frogs: 0
  };

  // Then rules definitions from JSON input (semantic mapping)
  const rules = {
    fish: {
      then_first: function(){
        showPanel(fishPanel);
        fishPanelText.textContent = 'Ribe plivaju slobodno u čistoj vodi.';
        statusText.textContent = 'Ribe: slobodno plivaju.';
        // ensure normal swim animation
        fishEls.forEach(el => {
          el.classList.remove('flee-left','flee-right','swim-fast');
          el.classList.add('swim-animation');
        });
      },
      then_next: [
        function(){
          // Add animation of fish fleeing from pollution and change text
          showPanel(fishPanel);
          fishPanelText.textContent = 'Zagađenje smanjuje broj riba.';
          statusText.textContent = 'Ribe beže od zagađenja...';
          // animate some fish fleeing left and right, fade small fishes
          fishEls.forEach((el, idx) => {
            el.classList.remove('swim-animation');
            if(idx % 2 === 0){
              el.classList.add('flee-left');
            } else {
              el.classList.add('flee-right');
            }
          });
          // small fishes disappear gradually
          smallFishes.forEach((s, i) => {
            s.style.transition = 'opacity 1.6s ease';
            s.style.opacity = String(0.15);
            // shrink
            s.style.transform += ' scale(0.6)';
          });
        }
      ]
    },
    plants: {
      then_first: function(){
        showPanel(plantsPanel);
        plantsPanelText.textContent = 'Biljke apsorbuju hranljive materije iz vode.';
        statusText.textContent = 'Biljke apsorbuju hranljive materije.';
      },
      then_next: [
        function(){
          showPanel(plantsPanel);
          plantsPanelText.textContent = 'Više sunca i hranljivih materija = više rasta.';
          statusText.textContent = 'Biljke rastu.';
          // add growth animation (scaleY)
          plantEls.forEach((p, i) => {
            // remove existing grow to restart
            p.classList.remove('grow');
            // force reflow
            void p.offsetWidth;
            p.classList.add('grow');
          });
        }
      ]
    },
    frogs: {
      then_first: function(){
        showPanel(frogsPanel);
        frogsPanelText.textContent = 'Vodozemci koriste vodu i obalu za život.';
        statusText.textContent = 'Vodozemci na obali.';
      },
      then_next: [
        function(){
          showPanel(frogsPanel);
          frogsPanelText.textContent = 'Promena temperature utiče na život vodozemaca.';
          statusText.textContent = 'Vodozemci skaču i zvuče.';
          // frogs jump with sound
          frogEls.forEach((f, idx) => {
            // stagger hops
            setTimeout(()=> {
              f.classList.remove('hop');
              void f.offsetWidth;
              f.classList.add('hop');
              playFrogSound(220 + idx*40, 0.08);
            }, idx*220);
          });
        }
      ]
    }
  };

  // Utility show panel
  function showPanel(panel){
    // hide all panels and show the requested
    [fishPanel, plantsPanel, frogsPanel].forEach(p => p.style.display = 'none');
    panel.style.display = 'block';
  }

  // Event listeners for clicks (IF conditions)
  fishGroup.addEventListener('click', (e)=>{
    e.stopPropagation();
    clickCounts.fish++;
    const rule = rules.fish;
    if(clickCounts.fish === 1){
      rule.then_first();
    } else {
      const idx = Math.min(clickCounts.fish - 2, rule.then_next.length - 1);
      rule.then_next[idx]();
    }
  });

  plantsGroup.addEventListener('click', (e)=>{
    e.stopPropagation();
    clickCounts.plants++;
    const rule = rules.plants;
    if(clickCounts.plants === 1){
      rule.then_first();
    } else {
      const idx = Math.min(clickCounts.plants - 2, rule.then_next.length - 1);
      rule.then_next[idx]();
    }
  });

  frogsGroup.addEventListener('click', (e)=>{
    e.stopPropagation();
    clickCounts.frogs++;
    const rule = rules.frogs;
    if(clickCounts.frogs === 1){
      rule.then_first();
    } else {
      const idx = Math.min(clickCounts.frogs - 2, rule.then_next.length - 1);
      rule.then_next[idx]();
    }
  });

  // When clicking outside, hide panels
  document.getElementById('scene').addEventListener('click', function(evt){
    // If clicked on empty area, hide panels but keep status
    const target = evt.target;
    // Only hide when click is not on a panel or control of interest
    if(!target.closest('.panel')){
      [fishPanel, plantsPanel, frogsPanel].forEach(p => p.style.display = 'none');
    }
  });

  // Water level states: Low, Normal, High
  const waterStates = ['Nizak', 'Normal', 'Visok'];
  let waterIndex = 1; // Normal
  waterBtn.addEventListener('click', ()=>{
    waterIndex = (waterIndex + 1) % waterStates.length;
    const label = waterStates[waterIndex];
    waterBtn.textContent = 'Nivo vode: ' + label;
    applyWaterState(label);
  });

  function applyWaterState(label){
    // Adjust river height and positions accordingly
    if(label === 'Nizak'){
      river.setAttribute('y', 200);
      river.setAttribute('height', 180);
      // expose more bank: plants near river become visible and amphibians farther from water
      leftBank.setAttribute('d', 'M0,360 Q120,320 220,340 L220,520 L0,520 Z');
      rightBank.setAttribute('d', 'M960,360 Q840,320 740,340 L740,520 L960,520 Z');
      // fish deeper? smaller area: lower opacity
      fishEls.forEach(f => f.style.transform += ' translateY(10px)');
      // show status
      statusText.textContent = 'Nizak nivo vode: manje prostora za ribe.';
      // adjust shimmer slightly
      document.querySelectorAll('.shine').forEach(s => s.style.opacity = '0.18');
    } else if(label === 'Normal'){
      river.setAttribute('y', 160);
      river.setAttribute('height', 240);
      leftBank.setAttribute('d', 'M0,360 Q120,320 220,340 L220,520 L0,520 Z');
      rightBank.setAttribute('d', 'M960,360 Q840,320 740,340 L740,520 L960,520 Z');
      // reset transforms
      fishEls.forEach(f => {
        f.style.transform = '';
      });
      statusText.textContent = 'Normalan nivo vode.';
      document.querySelectorAll('.shine').forEach(s => s.style.opacity = '0.28');
      // restore plants
      plantEls.forEach(p => { p.style.transform = ''; p.style.transition=''; });
    } else { // Visok
      river.setAttribute('y', 120);
      river.setAttribute('height', 300);
      // high water covers small plants and comes closer to bank
      leftBank.setAttribute('d', 'M0,360 Q120,300 220,320 L220,520 L0,520 Z');
      rightBank.setAttribute('d', 'M960,360 Q840,300 740,320 L740,520 L960,520 Z');
      statusText.textContent = 'Visok nivo vode: obala je pod vodom.';
      // when high water, plants near river may be partially submerged (scale down visual)
      plantEls.forEach((p,i) => {
        p.style.transition = 'transform 0.8s ease';
        p.style.transform = 'scaleY(0.9)';
      });
      document.querySelectorAll('.shine').forEach(s => s.style.opacity = '0.34');
    }
    // Small reaction of amphibians: when water high, frogs may move closer
    if(label === 'Visok'){
      frogsGroup.setAttribute('transform', 'translate(760,340)');
    } else {
      frogsGroup.setAttribute('transform', 'translate(780,360)');
    }
  }

  // Temperature states: Hladno, Normal, Toplo
  const tempStates = ['Hladno', 'Normal', 'Toplo'];
  let tempIndex = 1; // Normal
  tempBtn.addEventListener('click', ()=>{
    tempIndex = (tempIndex + 1) % tempStates.length;
    const label = tempStates[tempIndex];
    tempBtn.textContent = 'Temperatura: ' + label;
    applyTempState(label);
  });

  function applyTempState(label){
    if(label === 'Hladno'){
      // frogs less active: slower hop, less frequent
      // fish slower (reduce swim speed)
      fishEls.forEach(f => {
        f.classList.remove('swim-fast');
        f.style.opacity = '0.95';
      });
      // plants slower growth (if any)
      plantEls.forEach(p => p.style.transition = 'transform 2.5s ease');
      statusText.textContent = 'Hladna voda: vodozemci su manje aktivni.';
    } else if(label === 'Normal'){
      fishEls.forEach(f => {
        f.classList.remove('swim-fast');
        f.style.opacity = '1';
      });
      statusText.textContent = 'Normalna temperatura.';
      // restore fish color
      fishEls.forEach((f)=> {
        const body = f.querySelector('.body');
        if(body) body.setAttribute('fill', '#ff9f5a');
      });
    } else { // Toplo
      // warmer water -> plants grow faster, frogs more active (but can stress fish)
      plantEls.forEach(p => {
        p.style.transition = 'transform 1.2s ease';
      });
      // speed up fish swim
      fishEls.forEach(f => {
        f.classList.add('swim-fast');
      });
      // slight stress to fish elements: change color tint
      fishEls.forEach((f)=> {
        const body = f.querySelector('.body');
        if(body) body.setAttribute('fill', '#ff7f50'); // warmer color
      });
      // frogs hop more easily
      statusText.textContent = 'Topla voda: ubrzava metabolizam vodozemaca, ali može stresirati ribe.';
    }
  }

  // Reset functionality
  resetBtn.addEventListener('click', resetAll);

  function resetAll(){
    // Reset click counts
    clickCounts = { fish:0, plants:0, frogs:0 };
    // Reset panels
    [fishPanel, plantsPanel, frogsPanel].forEach(p => p.style.display = 'none');
    fishPanelText.textContent = 'Kliknite na ribe za informaciju.';
    plantsPanelText.textContent = 'Kliknite na biljke za informaciju.';
    frogsPanelText.textContent = 'Kliknite na vodozemce za informaciju.';
    // Reset visuals
    river.setAttribute('y',160);
    river.setAttribute('height',240);
    leftBank.setAttribute('d', 'M0,360 Q120,320 220,340 L220,520 L0,520 Z');
    rightBank.setAttribute('d', 'M960,360 Q840,320 740,340 L740,520 L960,520 Z');
    fishEls.forEach((f, i) => {
      f.classList.remove('flee-left','flee-right','swim-fast');
      f.classList.add('swim-animation');
      f.style.opacity = '1';
      f.style.transform = '';
      // reset fill color
      const body = f.querySelector('.body');
      if(body) body.setAttribute('fill', '#ff9f5a');
    });
    smallFishes.forEach(s => {
      s.style.opacity = '1';
      // reset transform scale
      s.style.transform = '';
    });
    plantEls.forEach(p => {
      p.classList.remove('grow');
      p.style.transform = '';
      p.style.transition = '';
    });
    frogEls.forEach(f => {
      f.classList.remove('hop');
      f.style.transform = '';
    });
    waterIndex = 1;
    tempIndex = 1;
    waterBtn.textContent = 'Nivo vode: Normal';
    tempBtn.textContent = 'Temperatura: Normal';
    frogsGroup.setAttribute('transform', 'translate(780,360)');
    statusText.textContent = 'Ekosistem vraćen u početno stanje.';
    document.querySelectorAll('.shine').forEach(s => s.style.opacity = '');
  }

  // Simple frog sound using WebAudio API
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch(e){
        audioCtx = null;
      }
    }
    return audioCtx;
  }
  function playFrogSound(freq = 220, time = 0.08){
    const ctx = ensureAudio();
    if(!ctx) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + time + 0.04);
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + time + 0.06);
  }

  // Small accessibility: keyboard events to trigger same behaviors
  document.addEventListener('keydown', (e)=>{
    if(e.key === '1') fishGroup.dispatchEvent(new Event('click'));
    if(e.key === '2') plantsGroup.dispatchEvent(new Event('click'));
    if(e.key === '3') frogsGroup.dispatchEvent(new Event('click'));
  });

  // Initial display adjustments: make panels in correct places and visible hidden
  // Starting state: show short hints in panels but hidden
  fishPanel.style.display = 'none';
  plantsPanel.style.display = 'none';
  frogsPanel.style.display = 'none';

  // Initial status text
  statusText.textContent = 'Kliknite na ribe, vodene biljke ili vodozemce za informacije. Pritisnite dugme za nivo vode ili temperaturu da vidite efekte.';

  // Provide hover hints via titles
  fishGroup.setAttribute('title', 'Kliknite na ribe');
  plantsGroup.setAttribute('title', 'Kliknite na vodene biljke');
  frogsGroup.setAttribute('title', 'Kliknite na vodozemce');

  // Make frogs bodies use CSS classes for fill (some SVG elements may not pick CSS color unless specified inline).
  frogEls.forEach(f => {
    f.querySelectorAll('ellipse').forEach(el => {
      if(el.classList.contains('body')) return;
      // mark as body or eye by position
    });
  });

  // End of immediately invoked function
})();
</script>

</body></html>